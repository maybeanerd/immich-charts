name: test-examples

on:
    pull_request:
        branches:
            - main
        paths:
            - 'charts/immich/**'
            - '.github/workflows/test-examples.yaml'

jobs:
    test-examples:
        name: Test example configurations
        permissions: write-all
        runs-on: ubuntu-latest
        container:
            image: alpine/helm:3.19.0
        strategy:
            matrix:
                example:
                    - minimal
                    - external-services
                    - ml-disabled
        steps:
            - name: Checkout PR head
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
              with:
                  fetch-depth: 0

            - name: Install chart dependencies
              run: helm dependency build charts/immich

            - name: Validate example can be rendered
              run: |
                  echo "Testing example: ${{ matrix.example }}"
                  helm template immich charts/immich -f charts/immich/examples/${{ matrix.example }}.yaml

            - name: Lint with example values
              run: helm lint charts/immich -f charts/immich/examples/${{ matrix.example }}.yaml

            - name: Create manifest from PR head
              run: |
                  mkdir -p charts/immich/build
                  helm template immich charts/immich \
                    -f charts/immich/examples/${{ matrix.example }}.yaml \
                    | tee charts/immich/build/manifest-${{ matrix.example }}.yaml

            - name: Checkout main
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
              with:
                  fetch-depth: 0
                  ref: main
                  path: main

            - name: Install chart dependencies (main)
              run: helm dependency build main/charts/immich

            - name: Create manifest from main
              run: |
                  mkdir -p main/charts/immich/build
                  if [ -f main/charts/immich/examples/${{ matrix.example }}.yaml ]; then
                    helm template immich main/charts/immich \
                      -f main/charts/immich/examples/${{ matrix.example }}.yaml \
                      | tee main/charts/immich/build/manifest-${{ matrix.example }}.yaml
                  else
                    echo "Example does not exist in main branch, skipping diff"
                    mkdir -p main/charts/immich/build
                    touch main/charts/immich/build/manifest-${{ matrix.example }}.yaml
                  fi

            - name: Create diff comment
              uses: int128/diff-action@c9db036f910af1c65d025ee9734f0aa2b0a47c39 # v1.58.0
              with:
                  base: main/charts/immich/build
                  head: charts/immich/build
                  comment-header: '## Example: ${{ matrix.example }}'
                  comment-footer: |
                      <details>
                      <summary>ðŸ“– About this example</summary>

                      This diff shows changes to the `${{ matrix.example }}` example configuration.
                      View the example file: [`charts/immich/examples/${{ matrix.example }}.yaml`](../blob/${{ github.event.pull_request.head.sha }}/charts/immich/examples/${{ matrix.example }}.yaml)
                      </details>

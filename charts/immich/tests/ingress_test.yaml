suite: test ingress configuration
chart:
  appVersion: '1.0.0'
templates:
  - templates/common.yaml
  - templates/postgresql.yaml
  - templates/redis.yaml

tests:
  - it: should create ingress when enabled (default)
    set:
      ingress.server.enabled: true
    asserts:
      - hasDocuments:
          count: 1
        documentSelector:
          path: kind
          value: Ingress

  - it: should NOT create ingress when disabled
    set:
      ingress.server.enabled: false
    asserts:
      - hasDocuments:
          count: 0
        documentSelector:
          path: kind
          value: Ingress

  - it: should set default host to immich.local
    set:
      ingress.server.enabled: true
    asserts:
      - contains:
          path: spec.rules
          content:
            host: immich.local
        documentSelector:
          path: kind
          value: Ingress

  - it: should have proxy-body-size annotation by default
    set:
      ingress.server.enabled: true
    asserts:
      - equal:
          path: metadata.annotations.[nginx.ingress.kubernetes.io/proxy-body-size]
          value: '0'
        documentSelector:
          path: kind
          value: Ingress

  - it: should route to server service
    set:
      ingress.server.enabled: true
    asserts:
      - contains:
          path: spec.rules[0].http.paths
          content:
            path: /
            pathType: Prefix
        documentSelector:
          path: kind
          value: Ingress

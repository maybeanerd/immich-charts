suite: test database configuration and env var mapping
chart:
  appVersion: '1.0.0'
templates:
  - templates/common.yaml
  - templates/postgresql.yaml
  - templates/redis.yaml

tests:
  - it: should set default database environment variables
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DB_HOSTNAME
            value: RELEASE-NAME-postgresql
        documentSelector:
          path: metadata.labels.[app.kubernetes.io/controller]
          value: server
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DB_USERNAME
            value: immich
        documentSelector:
          path: metadata.labels.[app.kubernetes.io/controller]
          value: server
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DB_DATABASE_NAME
            value: immich
        documentSelector:
          path: metadata.labels.[app.kubernetes.io/controller]
          value: server

  - it: should use external database host when configured
    set:
      immich.database.host: 'postgres.example.com'
      immich.database.port: 5432
      immich.database.username: 'testuser'
      immich.database.name: 'testdb'
      immich.database.password: 'testpass'
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DB_HOSTNAME
            value: postgres.example.com
        documentSelector:
          path: metadata.labels.[app.kubernetes.io/controller]
          value: server
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DB_USERNAME
            value: testuser
        documentSelector:
          path: metadata.labels.[app.kubernetes.io/controller]
          value: server
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DB_DATABASE_NAME
            value: testdb
        documentSelector:
          path: metadata.labels.[app.kubernetes.io/controller]
          value: server

  - it: should set DB_STORAGE_TYPE to HDD by default
    asserts:
      - equal:
          path: postgresql.primary.extraEnvVars[0].name
          value: DB_STORAGE_TYPE
        template: templates/postgresql.yaml
      - equal:
          path: postgresql.primary.extraEnvVars[0].value
          value: HDD
        template: templates/postgresql.yaml

  - it: should set DB_STORAGE_TYPE to SSD when configured
    set:
      immich.database.storageType: ssd
    asserts:
      - equal:
          path: postgresql.primary.extraEnvVars[0].value
          value: SSD
        template: templates/postgresql.yaml

  - it: should set default Redis hostname
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: REDIS_HOSTNAME
            value: RELEASE-NAME-redis-master
        documentSelector:
          path: metadata.labels.[app.kubernetes.io/controller]
          value: server

  - it: should use external Redis when configured
    set:
      immich.redis.host: 'redis.example.com'
      immich.redis.port: 6379
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: REDIS_HOSTNAME
            value: 'redis.example.com:6379'
        documentSelector:
          path: metadata.labels.[app.kubernetes.io/controller]
          value: server

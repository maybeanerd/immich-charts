suite: test persistence configuration
chart:
  appVersion: '1.0.0'
templates:
  - templates/common.yaml
  - templates/postgresql.yaml
  - templates/redis.yaml

tests:
  - it: should create library PVC by default
    asserts:
      - hasDocuments:
          count: 1
        documentSelector:
          path: metadata.name
          value: RELEASE-NAME-library

  - it: should create external PVC by default
    asserts:
      - hasDocuments:
          count: 1
        documentSelector:
          path: metadata.name
          value: RELEASE-NAME-external

  - it: should create ML cache PVC when ML is enabled (default)
    set:
      immich.machineLearning.enabled: true
    asserts:
      - hasDocuments:
          count: 1
        documentSelector:
          path: metadata.name
          value: RELEASE-NAME-machine-learning-cache

  - it: should NOT create ML cache PVC when ML is disabled
    set:
      immich.machineLearning.enabled: false
    asserts:
      - hasDocuments:
          count: 0
        documentSelector:
          path: metadata.name
          value: RELEASE-NAME-machine-learning-cache

  - it: should mount library volume to server
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: library
            persistentVolumeClaim:
              claimName: RELEASE-NAME-library
        documentSelector:
          path: metadata.labels.[app.kubernetes.io/controller]
          value: server

  - it: should mount ML cache to ML container when enabled
    set:
      immich.machineLearning.enabled: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: machine-learning-cache
            persistentVolumeClaim:
              claimName: RELEASE-NAME-machine-learning-cache
        documentSelector:
          path: metadata.labels.[app.kubernetes.io/controller]
          value: machine-learning
